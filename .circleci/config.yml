version: 2.1

jobs:
  build:
    working_directory: ~/solomeal
    docker:
      - image: cimg/ruby:2.7.6
    steps:
      - checkout:
          path: ~/solomeal
      - setup_remote_docker:
          version: 20.10.14
      - run:
          name: "サービスの開始および実行チェック"
          command: |
            docker run -d --name my-app my-app
            docker exec my-app curl --retry 10 --retry-connrefused http://localhost:8080
      - run:
          name: docker-compose up -d
          command: docker-compose build
      - run:
          name: run rspec
          command: docker-compose exec solomeal rspec -fd